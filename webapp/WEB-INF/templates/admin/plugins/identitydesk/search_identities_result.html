<#include "search_functions.html" />
<#include "offcanvasButton.ftl" />
<#include "offcanvasDesk.ftl" />
<@pageContainer>
    <@pageColumn flush=true id="search-identity-column">
        <#assign title><strong>Lancer</strong>une recherche dans notre <strong>referentiel d'identite</strong>
        </#assign>
        <#assign description>Pour effectuer une recherche, vous devez entrer un login ou fournir le nom, le pr&eacute;nom et la date de naissance</#assign>
        <#if identity_list?size gt 0 >
        <#assign description> Vous ne trouvez pas l'identit&eacute recherch&eacutee dans le r&eacutef&eacuterentiel d'identit&eacute ?   <button type="submit" class="btn btn-primary btn-sm text-decoration-none  border rounded-5" name="view_createIdentity">
            <small><i class="ti ti-user-plus"></i> Cr&eacuteer cette identit&eacute</small>
        </button>
        
        <a class="btn btn-dark btn-sm text-decoration-none  border rounded-5" href="jsp/admin/plugins/identitydesk/ManageIdentities.jsp?plugin_name=identitydesk&new_search=true"><small> <i class="ti ti-search"></i> Nouvelle recherche</small></a>  </#assign>
            <#if identity_list?size gt 1>
            <#assign title>Soyez attentif, <strong>${identity_list?size}</strong> utilisateurs trouv&eacute;s</#assign>
            <#elseif identity_list?size == 1 >
            <#assign title><strong>${identity_list?size}</strong> utilisateur trouv&eacute;</#assign>
            </#if>
        </#if>
        <@tform action="jsp/admin/plugins/identitydesk/ManageIdentities.jsp?action_searchIdentity">
            <@input type="hidden" name="token" value="${token}"/>
            <@input type="hidden" name="new_search" value=""/>
            <@input type="hidden" name="return_url" value="${(return_url)!''}"/>
            <div class="jumbotron jumbotron-fluid d-flex align-items-center justify-content-center text-center bg-secondary pb-4">
                <div class="col-8 mt-5 mb-5">
                    <@pageHeader title='${title}' description='${description}'>
                    </@pageHeader>
                    <@messages infos=infos />
                    <@messages errors=errors />
                    <@messages warnings=warnings />
                    <#if search_rules?size gt 0>
                    <@searchBox id="search-box-identity">
                    <#list search_rules as rule>
                        <#list rule as field>
                            <#assign fieldValue><#list query_search_attributes?filter(a -> a.key == field) as attr>${attr.value!''}</#list></#assign>
                            <#assign fieldType><#if field == "birthdate">date<#else>text</#if></#assign>
                            <#if field == "birthdate">
                            <#if fieldValue?length gt 0 >
                                <#assign date_dd_MM_yyyy = formatDate(fieldValue)>
                                <@searchInput name="search_${field}" label="${getName(field)}" value=date_dd_MM_yyyy type=fieldType   />
                                <#else>
                                <@searchInput name="search_${field}" label="${getName(field)}" value=fieldValue type=fieldType   />
                                </#if>
                                <#else>
                                <@searchInput name="search_${field}" label="${getName(field)}" value=fieldValue type=fieldType   />
                                </#if>
                            <#if field_has_next>
                                <@searchSeparator type="and" content="+" />
                            </#if>
                            <#if rule_has_next>
                                <@searchSeparator color="dark" type="or" content="#i18n{identitydesk.search_identities.or}" />
                            </#if>
                        </#list>
                    </#list>
                </@searchBox>
                </#if>
                <div class="mb-5 mt-2">   
                    <div class="float-end">
                      <#assign checked=true />
                      <#if approximate?exists>
                    <#if approximate>
                    <#assign checked=true />
                    <#else>
                    <#assign checked=false />
                    </#if>
                    <#else>
                    <#assign checked=true />
                    </#if>
                    <@listGroupItem>
                    <@checkBox orientation='switch' id='approximate' name='approximate'  labelKey='#i18n{identitydesk.search_identities.approximateSearch}' value='true' mandatory=false  checked=checked />
                </@listGroupItem></div>
                  </div>
                </div>
            </div>
            <div class="container-fluid mt-5 px-5" style="margin-top:-54px !important;">
                <#if identity_list?size gt 0>
                    <@table headBody=true class="table-hover">
                        <@tr>
                            <@th>#</@th>
                            <@th>#i18n{identitydesk.search_identities.name}</@th>
                            <@th>#i18n{identitydesk.search_identities.birthplace}</@th>
                            <@th>#i18n{identitydesk.search_identities.adress}</@th>
                            <@th>#i18n{identitydesk.search_identities.contact}</@th>
                            <@th><center>#i18n{identitydesk.search_identities.monparis}</center></@th>
                            <@th><center>#i18n{identitydesk.search_identities.pivot}</center></@th>
                            <@th><center>#i18n{identitydesk.search_identities.quality}</center></@th>
                            <@th></@th>
                        </@tr>
                        <#list identity_list as identity>
                            <tr class="filtering-item"
                                <#list service_contract.attributeDefinitions?filter(a -> a.attributeRight.searchable && a.keyName != 'birthplace_code' && a.keyName != 'birthcountry_code' && a.keyName != 'login') as searchableAttr>
                                    <#list identity.attributes?filter(a -> a.key == searchableAttr.keyName) as attr>
                                        data-filter-${searchableAttr.keyName}="${attr.value}"
                                    </#list>
                                </#list>
                            >
                                <@td>
                                    ${identity?index + 1}
                                </@td>
                                <@td>
                                    <strong>${getAttributeValue(identity.attributes, 'family_name')}</strong>   ${getAttributeValue(identity.attributes, 'first_name')}<br>
                                    <i>${getAttributeValue(identity.attributes, 'preferred_username')}</i>
                                </@td>
                                <@td>${getAttributeValue(identity.attributes, 'birthdate')}<br>
                                    ${getAttributeValue(identity.attributes, 'birthplace')}<#if getAttributeValue(identity.attributes, 'birthplace')?length != 0>,
                                    </#if>
                                    ${getAttributeValue(identity.attributes, 'birthcountry')}<br>
                                </@td>
                                <@td>${getAttributeValue(identity.attributes, 'address')}<br>
                                    ${getAttributeValue(identity.attributes, 'address_city')}<#if getAttributeValue(identity.attributes, 'address_city')?length != 0>,
                                    </#if>
                                    ${getAttributeValue(identity.attributes, 'address_postal_code')}<br>
                                </@td>
                                <@td>
                                    ${getAttributeValue(identity.attributes, 'mobile_phone')}<br>
                                        ${getAttributeValue(identity.attributes, 'email')}
                                </@td>
                                <td class="text-center">
                                    <#if identity.connectionId??> 
                                        <#assign colorClass = "success">
                                        <strong class="text-${colorClass}">#i18n{identitydesk.search_identities.yes}</strong><br>
                                        <span>${getAttributeValue(identity.attributes, 'login')}</span>
                                    <#else>
                                        <#assign colorClass = "danger">
                                        <strong class="text-${colorClass}">#i18n{identitydesk.search_identities.no}</strong>
                                    </#if>

                                </td>
                                <td>
                                    <center>${getCertifierPivotBadge(identity.attributes)}</center>
                                </td>
                                <td class="text-center">
                                    <#assign qualityPercent = (identity.quality.quality * 100)?string("0")>
                                    <#if qualityPercent?number gt 80>
                                        <#assign colorClass = "success">
                                    <#elseif qualityPercent?number gt 50>
                                        <#assign colorClass = "warning">
                                    <#else>
                                        <#assign colorClass = "danger">
                                    </#if>
                                    <span class="text-${colorClass}-emphasis bg-${colorClass}-subtle border border-${colorClass}-subtle badge rounded-5">${qualityPercent}%</span>
                                </td>
                                <@td>
                                    <@offcanvasDesk
                                    id="summarize-${identity?index}"
                                    title="#i18n{identitydesk.search_identities.detail}" size="auto">

                                        #i18n{identitydesk.search_identities.detail.cuid}
                                        <#if identity.connectionId??>
                                            <strong>${identity.connectionId}</strong>
                                        </#if><br>
                                        #i18n{identitydesk.search_identities.detail.guid} <strong>${identity.customerId}</strong> <br>
                                        #i18n{identitydesk.search_identities.detail.creationdate} <strong>${identity.creationDate}</strong>,
                                        #i18n{identitydesk.search_identities.detail.modificationdate} <strong>${identity.lastUpdateDate}</strong>,
                                        #i18n{identitydesk.search_identities.detail.expirationdate}
                                        <#if identity.expiration??>
                                            <strong>${identity.expiration}</strong>
                                        </#if><br>
                                        #i18n{identitydesk.search_identities.detail.monparis}
                                        <#if identity.connectionId??>
                                            <#assign colorClass = "success">
                                                <strong class="text-${colorClass}">#i18n{identitydesk.search_identities.yes}</strong>
                                        <#else>
                                            <#assign colorClass = "danger">
                                            <strong class="text-${colorClass}">#i18n{identitydesk.search_identities.no}</strong>
                                        </#if> <br><br>
                                        <table class="table table-hover shadow-lg">
                                            <thead>
                                                <@th>#i18n{identitydesk.search_identities.detail.attribut}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.value}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.mandatory}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.certfication}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.level}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.minimum}</@th>
                                                <@th>#i18n{identitydesk.search_identities.detail.score}</@th>
                                            </thead>
                                            <tbody>
                                                <#assign attributeOrder = ["gender","name","family_name","preferred_username",
                                                "first_name","birthdate","birthplace","birthplace_code","birthcountry",
                                                "birthcountry_code","login","email","mobile_phone", "fixed_phone",
                                                "address","address_detail","address_city","address_postal_code"]>
                                                <#list attributeOrder as orderItem>
                                                    <#list service_contract.attributeDefinitions as serviceContractAttr>
                                                        <#if serviceContractAttr.keyName == orderItem>
                                                            <#if serviceContractAttr.attributeRight.mandatory >
                                                                <#assign mandatory = "#i18n{identitydesk.search_identities.detail.yes}">
                                                            <#else>
                                                                <#assign mandatory = "#i18n{identitydesk.search_identities.detail.no}">
                                                            </#if>
                                                            <#if serviceContractAttr.keyName != "fc_key">
                                                                <#if serviceContractAttr.attributeRight.readable>
                                                                    <#list identity.attributes?filter(a -> a.key == serviceContractAttr.keyName) as attr>
                                                                        <#if attr.value == "">
                                                                            <#assign level = "0" >
                                                                        <#else>
                                                                            <#assign level = "${getAttributeCertificationLevel('${attr.certifier}', '${attr.key}')}" >
                                                                        </#if>
                                                                        <#assign levelMax = "${getHighestLevelForAttributeKey('${attr.key}')}" >
                                                                        <#assign ratio = (level?number / levelMax?number) * 100>
                                                                        <#assign bgColor><#if ratio = 100 >success<#elseif ratio gt 50>warning<#else>danger</#if></#assign>
                                                                        <tr data-attribute-key="${serviceContractAttr.keyName}" data-attribute-name="${serviceContractAttr.name}"  data-score=${ratio?round}>
                                                                            <@td>${serviceContractAttr.name}</@td>
                                                                            <@td><strong>
                                                                                <#if serviceContractAttr.keyName == "gender">
                                                                                    <#if attr.value = "0" >
                                                                                        Non d&#x00E9;fini
                                                                                    <#elseif attr.value = "1">
                                                                                        MME
                                                                                    <#elseif attr.value = "2">
                                                                                        MR
                                                                                    </#if>
                                                                                <#else>
                                                                                    ${attr.value}
                                                                                </#if>
                                                                            </strong></@td>
                                                                            <@td>${mandatory}</@td>
                                                                            <td class="text-center">
                                                                                <#if attr.value != "" >
                                                                                    <#if serviceContractAttr.attributeRequirement?exists>
                                                                                        <#if level?number gte serviceContractAttr.attributeRequirement.level?number >
                                                                                            <@tag color="success"><i class="ti ti-check"></i>  ${attr.certifier} (${level})</@tag>
                                                                                        <#else>
                                                                                            <@tag color="danger"><i class="ti ti-x"></i> ${attr.certifier} (${level})</@tag>
                                                                                        </#if>
                                                                                    <#else>
                                                                                        <@tag color="success"><i class="ti ti-check"></i>  ${attr.certifier} (${level})</@tag>
                                                                                    </#if>
                                                                                </#if>
                                                                            </td>
                                                                            <@td>
                                                                                <#if attr.value != "">
                                                                                    <strong>${level}</strong> / ${levelMax}
                                                                                </#if>
                                                                            </@td>
                                                                            <@td>
                                                                                <#if attr.value != "">
                                                                                    <#if serviceContractAttr.attributeRequirement?exists>
                                                                                        ${getAttributeCodeByLevel('${serviceContractAttr.attributeRequirement.level}', '${attr.key}')}
                                                                                    <#else>
                                                                                        #i18n{identitydesk.search_identities.detail.none}
                                                                                    </#if>
                                                                                </#if>
                                                                            </@td>
                                                                            <@td>
                                                                                <#if attr.value != "">
                                                                                    <@tag color=bgColor >
                                                                                        <#if ratio = 100 >#i18n{identitydesk.search_identities.detail.certification.strong}<#elseif ratio gt 50>#i18n{identitydesk.search_identities.detail.certification.medium}<#else>#i18n{identitydesk.search_identities.detail.certification.weak}</#if>
                                                                                    </@tag>
                                                                                </#if>
                                                                            </@td>
                                                                        </tr>
                                                                    </#list>
                                                                    <#if identity.attributes?filter(a -> a.key == serviceContractAttr.keyName)?size == 0>
                                                                        <#assign levelMax = "${getHighestLevelForAttributeKey('${serviceContractAttr.keyName}')}" >
                                                                        <tr data-attribute-key="${serviceContractAttr.keyName}" data-attribute-name="${serviceContractAttr.name}" data-score=0>
                                                                            <@td>${serviceContractAttr.name}</@td>
                                                                            <@td></@td>
                                                                            <@td>${mandatory}</@td>
                                                                            <@td></@td>
                                                                            <@td></@td>
                                                                            <@td></@td>
                                                                            <@td></@td>
                                                                        </tr>
                                                                    </#if>
                                                                <#else>
                                                                    <tr data-attribute-key="${serviceContractAttr.keyName}" data-attribute-name="${serviceContractAttr.name}" data-score=0>
                                                                        <@td>${serviceContractAttr.name}</@td>
                                                                        <@td>non lisible</@td>
                                                                        <@td>${mandatory}</@td>
                                                                        <@td>non lisible</@td>
                                                                        <@td>non lisible</@td>
                                                                        <@td>non lisible</@td>
                                                                        <@td>non lisible</@td>
                                                                    </tr>
                                                                </#if>
                                                            </#if>
                                                        </#if>
                                                    </#list>
                                                </#list>
                                            </tbody>
                                        </table>
                                    </@offcanvasDesk>
                                    <#if (isAttributeExists(identity.attributes, 'login') = false) || (return_url?exists)>
                                        <@aButton class='dropdown-toggle rounded-5' size='sm' id='portlet-type' dropdownMenu=true href='#'
                                        title='#i18n{portal.util.labelActions}' color="light" buttonIcon='th-large'
                                        hideTitle=['xs','sm','md']>
                                            <#if isAttributeExists(identity.attributes, 'login') = false >
                                                <@dropdownItem
                                                href='jsp/admin/plugins/identitydesk/ManageIdentities.jsp?view_modifyIdentity&customer_id=${identity.customerId}'
                                                title='#i18n{identitydesk.search_identities.buttonModifyIdentity}' disabled=editDisabled />
                                            </#if>
                                            <#if return_url?exists>
                                                <@dropdownItem
                                                href='${return_url}?cuid=${identity.customerId}'
                                                title='#i18n{identitydesk.search_identities.buttonSelectIdentityAndReturn}' />
                                            </#if>
                                        </@aButton>
                                    </#if>
                                    <@aButton class='dropdown-toggle rounded-5' size='sm' id='portlet-type' dropdownMenu=true title='#i18n{portal.util.labelActions}' >
                                        <@offcanvasButton id="btnSummarize-${identity?index}"
                                        idcanvas="summarize-${identity?index}"
                                        title="#i18n{identitydesk.search_identities.buttonCheckIdentity}" />
                                        <br>
                                        <br>
                                        <a class="btn btn-primary btn-sm"
                                           href='jsp/admin/plugins/identitydesk/ManageIdentities.jsp?view_modifyIdentity&customer_id=${identity.customerId}'
                                        >#i18n{identitydesk.search_identities.buttonModifyIdentity}</a>
                                    </@aButton>
                                </@td>
                            </tr>
                        </#list>
                    </@table> 
                </#if>
            </div>
        </@tform>
    </@pageColumn>
</@pageContainer>
