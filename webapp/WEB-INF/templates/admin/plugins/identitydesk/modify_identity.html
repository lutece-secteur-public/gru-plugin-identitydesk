<#-- include "manageidentities_tabs.html" />
<@tabs tab="identity" /> -->

<style>
    #identity-update-table select {
        min-width: 280px;
        text-align: center;
    }
    #identity-update-table input {
        min-width: 400px;
    }
    #identity-update-table th {
        text-align: center;
    }
    td.certifier-td, td.certification-date-td, td.action-td {
        text-align: center;
    }
    #identity-update-table tr {
        height: 45px;
    }
    #identity-update-table td.status-td {
        font-weight: bold;
        color: orange;
    }
</style>
<script type="text/javascript">
    $(function () {
        $('#identity-update-table td, #identity-update-table th').each(function () {
            if ($(this).hasClass('certifier-td')) {
                $(this).addClass('ps-3');
            } else if ($(this).hasClass('certification-date-td')) {
                $(this).addClass('pe-4');
            } else {
                $(this).addClass("px-3");
            }
        });
        $('button[name="action_modifyIdentity"]').click(function (e) {
            $('#mandatory-msg').hide();
            $('input.mandatory').each(function () {
                if (!$(this).val().trim()) {
                    e.preventDefault();
                    $(this).addClass('border-danger');
                    $('#mandatory-msg').show();
                }
            });
        });
        $("input[name='birthplace']").autocomplete({
            minLength: 3,
            source: function (request, response) {
                $.ajax({
                    url: '${autocomplete_city_endpoint}' + request.term,
                    type: 'GET',
                    contentType: 'application/json',
                    dataType: "json",
                    data: '',
                    success: function (data) {
                        if (data.status === 'OK') {
                            response($.map(data.result, function (city) {
                                let dpt = city.codeZone;
                                if (dpt.length === 1) {
                                    dpt = '0' + dpt;
                                }
                                if (dpt) {
                                    dpt = ' (' + dpt + ')';
                                } else {
                                    dpt = '';
                                }
                                return {
                                    label: city.value + dpt,
                                    value: city.code
                                };
                            }));
                        }
                    }
                });
            },
            select: function (event, ui) {
                event.preventDefault();
                let cityName = ui.item.label;
                if (cityName.startsWith('(') && cityName.length > 5) {
                    cityName = cityName.substring(5).trim();
                }
                $("input[name='birthplace']").val(cityName);
                $("input[name='birthplace_code']").val(ui.item.value);
            }
        });
        $("input[name='birthplace']").keyup(function () {
            $("input[name='birthplace_code']").val('');
        });
        $("input[name='birthcountry']").autocomplete({
            minLength: 3,
            source: function (request, response) {
                $.ajax({
                    url: '${autocomplete_country_endpoint}' + request.term,
                    type: 'GET',
                    contentType: 'application/json',
                    dataType: "json",
                    data: '',
                    success: function (data) {
                        if (data.status === 'OK') {
                            response($.map(data.result, function (country) {
                                return {
                                    label: country.value,
                                    value: country.code
                                };
                            }));
                        }
                    }
                });
            },
            select: function (event, ui) {
                event.preventDefault();
                $("input[name='birthcountry']").val(ui.item.label);
                $("input[name='birthcountry_code']").val(ui.item.value);
            }
        });
        $("input[name='birthcountry']").keyup(function () {
            $("input[name='birthcountry_code']").val('');
        });
        $("option[title]").each(function() {
            $(this).parent().attr('title', $(this).attr('title'))
        });
        $("select[name$='-certif']").change(function () {
        	// show input only if a certification process is selected
        	// restore value if certification is unselect
        	let attrKey = $(this).prop("name").substring(0, $(this).prop("name").indexOf( '-certif' ));
        	let attrInput =   $( '#' + attrKey );
        	attrInput.toggle( $(this).find("option:selected").val() != "" ) ;
        	if ( $(this).find("option:selected").val() == "" ) attrInput.val( $('#'+ attrKey + '-svg').text() );
        	
        	// ?
        	let title = $(this).find("option:selected").attr('title');
            if (title) {
                $(this).attr('title', title);
            } else {
                $(this).removeAttr('title');
            }
        });
        
        // init
        $("select[name$='-certif']").change();
    });
</script>

<@rowBoxHeader i18nTitleKey="identitydesk.modify_identity.title">
    <form class="form-horizontal" method="post" name="modify_identity" action="jsp/admin/plugins/identitydesk/ManageIdentities.jsp">
        <@messages infos=infos />
        <@messages errors=errors />
        <@messages warnings=warnings />
        <input type="hidden" name="return_url" value="${(return_url)!''}">
        <input type="hidden" name="customer_id" value="${identity.customerId}"/>

        <table id="identity-update-table" class="mb-4">
            <thead>
                <tr>
                    <th>&nbsp;</th>
                    <th>#i18n{identitydesk.createmodify_identity.columnValue}</th>
                    <th colspan="2">#i18n{identitydesk.createmodify_identity.columnCertif}</th>
                    <th>#i18n{identitydesk.modify_identity.columnAction}</th>
                    <th>Nouvelle valeur</th>
                    <#if attribute_statuses?has_content>
                        <th>#i18n{identitydesk.createmodify_identity.columnStatus}</th>
                    </#if>
                </tr>
            </thead>
            <tbody>
                <#list identity.attributeList as attr>
                    <#assign isUpdateAllowed =  attr.updatable && attr.allowedCertificationList?has_content />
                    
                    <#if attr.key == 'birthplace_code' || attr.key == 'birthcountry_code'>
                        <input type="hidden" name="${attr.key}" value="${(attr.value)!''}" />
                    <#else>
                        <tr>
                            <td>${attr.name}<#if attr.mandatory>&nbsp; *</#if> <span class="badge badge-pill badge-info" title="${attr.description}">?</span></td>
                           
                            <td class="action-td">
	                            <span id="${attr.key}-svg" >${(attr.value)!''}</span>
                            </td>
                            <td class="certifier-td">
                                <#if attr.certifier??>
                                    <span class="badge badge-pill badge-info mx-1">${attr.certifier}</span>
                                </#if>
                            </td>
                            <td class="certification-date-td">
                                <#if attr.certificationDate??>
                                    <span class="certification-date">${attr.certificationDate?date}</span>
                                </#if>
                            </td>
                            <td class="action-td">
                                <#if isUpdateAllowed >
                                    <select class="form-control w-auto" name="${attr.key}-certif">
                                        <option selected value> -- #i18n{identitydesk.modify_identity.optionModifyCertif} -- </option>
                                        <#list attr.allowedCertificationList as certif>
                                            <option value="${certif.code}">[${certif.code}] ${certif.label}</option>
                                        </#list>
                                    </select>
                                <#else>
                                    #i18n{identitydesk.modify_identity.nonUpdatableAttribute}
                                </#if>
                            </td>
                            <td>
                                <#if isUpdateAllowed >
                                   <input class="form-control  <#if attr.mandatory>mandatory</#if>" type="text" name="${attr.key}" id="${attr.key}"  value="${(attr.value)!''}"  /> 
                                </#if>
                            </td>
                            <#if attribute_statuses?has_content>
                                <td class="status-td">
                                    <#list attribute_statuses?filter(s -> s.key == attr.key) as attrStatus>
                                        ${attrStatus.status.message}
                                    </#list>
                                </td>
                            </#if>
                        </tr>
                    </#if>
                </#list>
            </tbody>
        </table>

        <@actionButtons button1Name="action_modifyIdentity" button2Name="view_manageIdentitys"/>
        <div id="mandatory-msg" class="text-danger" style="display: none">
            #i18n{identitydesk.createmodify_identity.mandatoryFieldsWarning}
        </div>
    </form>
</@rowBoxHeader>

